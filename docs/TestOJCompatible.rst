TestOJ Websocket APIs
================================

Challenge Request JSON Format
---------------------

.. code:: python

    ${CHALREQ}
    {
        "chal_id": ${CHALLENGE_ID},
        "code_path": ${CODE_PATH},
        "res_path": ${RES_PATH},
        "comp_type": ${COMP_TYPE},
        "check_type": ${CHECK_TYPE},
        "metadata": ${CHALMETA},
        "test": [${TEST},...]
    }


Challenge Response JSON Format
------------------------------

.. code:: python

    ${CHALRESP}
    {
        "chal_id": ${CHALLENGE_ID},
        "verdict": ${VERDICT},
        "result": [${RESULT},...]
    }


Test JSON Format
----------------

.. code:: python

    ${TEST}
    {
        "timelimit": ${TIMELIMIT},
        "memlimit": ${MEMLIMIT},
        "metadata": ${TESTMETA}
    }


Result JSON Format
------------------

.. code:: python

    ${RESULT}
    {
        "state": ${STATE},
        "runtime": ${RUNTIME},
        "peakmem": ${PEAKMEM},
        "verdict": ${VERDICT}
    }


Diff Check Type
---------------

The ``${TESTMETA}`` format.

.. code:: python

    ${TESTMETA}
    {
        "data": [${TESTDATA_ID},...]
    }


``${TESTDATA_ID}`` are IDs of testdata used in the test. The judge will access testdata by opening ``${RES_PATH}/testdata/data${TESTDATA_ID}.in`` and ``${RES_PATH}/testdata/data${TESTDATA_ID}.out``.

The file structure of ``${RES_PATH}`` directory.

.. code::

    ${RES_PATH}/
        testdata/
            1.in
            1.out
            ...


IORedir Check Type
------------------

The ``${TESTMETA}`` format.

.. code:: python
    
    ${TESTMETA}
    {
        "data": [${TESTDATA_ID},...],
        "redir_test": {
            "testin": -1|${TARGET_FD},
            "testout": -1|${TARGET_FD},
            "pipein": -1|${TARGET_FD},
            "pipeout": -1|${TARGET_FD},
        },
        "redir_check": {
            "testin": -1|${TARGET_FD},
            "ansin": -1|${TARGET_FD},
            "pipein": -1|${TARGET_FD},
            "pipeout": -1|${TARGET_FD},
        }
    }


Each ``${TARGET_FD}`` is the individual target file descriptor which the corresponding soruce redirect to. Setting to -1 means do not redirect the source.

``${TESTDATA_ID}`` are IDs of testdata used in the test. The judge will access testdata by opening ``${RES_PATH}/testdata/data${TESTDATA_ID}.in`` and ``${RES_PATH}/testdata/data${TESTDATA_ID}.out``.

The file structure of ``${RES_PATH}`` directory.

.. code::

    ${RES_PATH}/
        testdata/
            1.in
            1.out
            ...
        check/
            build
            check


The ``${RES_PATH}/check/build`` will be executed to build the checker if it exists.

The ``${RES_PATH}/check/check`` will be run as checker. It can be packed in the ``${RES_PATH}`` directly, or be generated by the ``build``. The checker should be a lambda. It must have no side effects.

There are two environment variables ``OUTPUT`` and ``VERDICT`` passed to the checker. The ``OUTPUT`` is the path of the test output file. The ``VERDICT`` is the file in which the checker can write down the verdict.
